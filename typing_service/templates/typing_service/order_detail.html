{% extends 'print_service/base.html' %}
{% load static %}
{% load i18n %}

{% block title %}جزئیات سفارش تایپ #{{ order.id }}{% endblock %}

{% block content %}
<div class="container my-5">

    <h2 class="mb-4 text-center">سفارش تایپ #{{ order.id }}</h2>

    <!-- اطلاعات سفارش -->
    <div class="card mb-4">
        <div class="card-body">
            <p><strong>نام کاربر:</strong> {{ order.user_name }}</p>
            <p><strong>ایمیل:</strong> {{ order.user_email }}</p>
            <p><strong>تاریخ ثبت سفارش:</strong> {{ order.created_at|date:"Y-m-d H:i" }}</p>
            <p><strong>وضعیت سفارش:</strong> {{ order.get_status_display }}</p>
            {% if order.estimated_delivery %}
                <p><strong>زمان تخمینی تحویل:</strong> {{ order.estimated_delivery|date:"Y-m-d H:i" }}</p>
            {% endif %}
        </div>
    </div>

    <!-- نمایش انیمیشن در صورت درحال انجام بودن سفارش -->
    {% if order.status == 'accepted' and not order.final_approved %}
    <div class="text-center my-4">
        <img src="{% static 'typing_service/img/your_typing_gif.gif' %}" 
             alt="Typing in progress" 
             style="max-height: 120px;">
        <p class="text-muted mt-2">سفارش شما در حال انجام است.</p>
    </div>
    {% endif %}

    <!-- فایل تایپ‌شده -->
    {% if order.typed_files.all %}
        <hr>
        <h4>فایل تایپ‌شده:</h4>

        {% if order.final_approved %}
            <div class="alert alert-success">
                فایل تایپ‌شده تأیید شده است و آماده دانلود می‌باشد:
            </div>
            <ul>
                {% for f in order.typed_files.all %}
                    <li>
                        <a href="{{ f.file.url }}" target="_blank">دانلود فایل {{ forloop.counter }}</a>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="alert alert-info">
                فایل تایپ‌شده فقط قابل مشاهده است. برای دریافت نهایی منتظر تأیید مدیر باشید.
            </div>
            {% for f in order.typed_files.all %}
                <div class="border mt-3 p-2 shadow" style="position: relative;">
                    <iframe src="{{ f.file.url }}#toolbar=0&navpanes=0&scrollbar=0"
                            width="100%" height="500"
                            style="pointer-events: none;"
                            oncontextmenu="return false;"></iframe>
                    <div style="position: absolute; top:0; left:0; right:0; bottom:0; background: transparent;"
                         oncontextmenu="return false" 
                         onselectstart="return false"
                         onmousedown="return false"
                         oncopy="return false"
                         ondragstart="return false">
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    {% endif %}

    {% if order.typed_files.all and not order.final_approved_by_user %}
    <hr>
    <div class="text-center my-4">
        <form method="post">
            {% csrf_token %}
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#finalApprovalModal">
                تأیید نهایی فایل تایپ‌شده
            </button>

            <!-- Modal -->
            <div class="modal fade" id="finalApprovalModal" tabindex="-1" aria-labelledby="finalApprovalModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-warning">
                            <h5 class="modal-title" id="finalApprovalModalLabel">تأیید نهایی</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"></button>
                        </div>
                        <div class="modal-body">
                            <p>با تأیید نهایی، فایل تایپ‌شده مورد تأیید شما قرار می‌گیرد و امکان بازنویسی یا اصلاح وجود نخواهد داشت.</p>
                            <p><strong>توجه:</strong> مسئولیت صحت فایل پس از تأیید بر عهده شماست.</p>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="agreeCheck">
                                <label class="form-check-label" for="agreeCheck">
                                    موافقم و مسئولیت را می‌پذیرم.
                                </label>
                            </div>

                            <hr>
                            <p class="mt-3">لطفاً یکی از روش‌های دریافت را انتخاب کنید:</p>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="delivery_option" id="printOption" value="print" checked>
                                <label class="form-check-label" for="printOption">
                                    دریافت نسخه چاپی توسط کارمند
                                </label>
                            </div>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" name="delivery_option" id="emailOption" value="email">
                                <label class="form-check-label" for="emailOption">
                                    ارسال فایل به ایمیل من
                                </label>
                            </div>

                            <input type="hidden" name="final_user_approval" value="true">
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success" id="finalApproveBtn" disabled>تأیید و ادامه</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <script>
        const check = document.getElementById('agreeCheck');
        const btn = document.getElementById('finalApproveBtn');
        check.addEventListener('change', () => {
            btn.disabled = !check.checked;
        });
    </script>
{% endif %}

    <!-- دکمه بازگشت -->
    <div class="mt-4 text-center">
        <a href="/" class="btn btn-secondary">بازگشت به صفحه اصلی</a>
    </div>

</div>
{% endblock %}